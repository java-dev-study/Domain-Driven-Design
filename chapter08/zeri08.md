## 8장. 애그리거트 트랙잭션 관리

<br>
<br>

### 8-1. 애그리거트와 트랜잭션
***
한 주문 애그리거트에 대해 운영자는 배송 상태로 변경할 때 사용자는 배송지 주소를 변경할 경우
- 운영자 스레드가 주문 애그리거트 객체를 배송 상태를 변경하더라도 고객 스레드가 사용하는 주문 애그리거트 객체에는 영향을 주지 않는다.
- 고객 스레드 입장에서 주문 애그리거트 객체는 아직 배송 상태 전이므로 변경할 수 있다.
- 두 스레드는 각각 트랜잭션을 커밋할 때 수정한 내용을 DB에 반영한다. 이 시점에서 배송 상태로 바뀌고 배송지 정보도 바뀌게 된다. 이 순서의 문제점은 운영자는 기존 배송지 정보를 이용해서 배송 상태로 변경했는데 그 사이 고객은 배송지 정보를 변경했다는 점이다.

  
    
    
    
일관성이 깨지는 문제가 발생하지 않도록
- 운영자가 배송지 정보를 조회하고 상태를 변경하는 동안, 고객이 애그리거트를 수정하지 못하게 된다.
- 운영자가 배송지 정보를 조회한 이후에 고객이 정보를 변경하면, 운영자가 애그리거트를 다시 조회한 뒤 수정하도록 한다.


- 트랜잭션 처리 방식
  -  선점 잠금
  -  비선점 


<br>
<br>

### 8-2. 선점 잠금
***
- 선점 잠금이란
  -  먼저 애그리거트를 구한 스레드가 애그리거트 사용이 끝날 때까지 다른 스레드가 해당 애그리거트를 수정하지 못하게 막는 방식이다.
  
  
선점 잠금 기능을 사용할 때는 잠금 순서에 따른 교착 상태가 발생하지 않도록 주의해야한다.

1. 스레드1 : A애그리거트에 대한 선점 잠금 구함
2. 스레드2 : B애그리거트에 대한 선점 잠금 구함
3. 스레드1 : B애그리거트에 대한 선점 잠금 시도
4. 스레드2 : A애그리거트에 대한 선점 잠금 시도



<br>
<br>


### 8-3. 비선점 잠금
***
비선점 잠금을 위한 쿼리를 실행할 때 쿼리 실행 결과로 수정된 행의 개수가 0이면 이미 누군가가 앞서 데이터를 수정한 것이다. 이는 트랙잭션이 충돌한 것이므로 트랜잭션 종료 시점에 익셉션이 발생한다. 
   
시스템은 사용자에게 수정 폼을 제공할 때 애그리거트 버전을 함께 제공하고, 폼을 서버에 전송할 때 이 버전을 함께 전송한다.
  


<br>
<br>

### 8-4.오프라인 선점 잠금
***
- 표현 영역의 책임
  - 사용자가 시스템을 사용할 수 있는 흐름(화면)을 제공하고 제어한다
  - 사용자의 요청을 알맞은 응용 서비스에 전달하고 결과를 사용자에게 제공한다
  - 사용자의 세션을 관리한다


<br>
<br>
