### Chapter08 애그리거트 트랜잭션 관리

#### 8.1 애그리거트와 트랜잭션

- 애그리거트의 일관성을 유지하기 위해서는 DBMS가 지원하는 트랜잭션과 함께 애그리거트를 위한 추가적인 트랜잭션 처리 기법이 필요함
- ex) 운영자와 고객이 동시에 한 주문 애그리거트를 수정하는 상황

#### 8.2 선점 잠금

- 선점 잠금은 먼저 애그리거트를 구한 스레드가 애그리거트 사용이 끝날 때까지 다른 스레드가 해당 애그리거트를 수정하지 못하게 막는 방식
- 한 스레드가 애그리거트를 구하고 수정하는 동안 다른 스레드가 수정할 수 없으므로 동시에 애그리거트를 수정할 때 발생하는 데이터 충돌 문제 해소 가능
- 선점 잠금 기능을 사용할 때는 잠금 순서에 따라 교착 상태가 발생하지 않도록 주의해야함
- JPA에서 선점 잠금 시도 시 힌트를 사용하여 최대 대기 시간 지정 가능 (DBMS가 관련 기능을 지원하는지 확인 필요)

#### 8.3 비선점 잠금

- 비선점 잠금은 동시에 접근하는 것을 막는 대신 변경한 데이터를 실제 DBMS에 반영하는 시점에 변경 가능 여부를 확인하는 방식
- 애그리거트를 수정할 때마다 버전으로 사용할 숫자 프로퍼티 값이 1씩 증가함
- 애그리거트 내에 어떤 구성요소의 상태가 바뀌면 루트 애그리거트의 버전값이 증가해야 비선점 잠금이 올바르게 동작함

#### 8.4 오프라인 선점 잠금

- 여러 트랜잭션에 걸쳐 동시 변경을 막음
- 트랜잭션을 시작할 때 오프라인 잠금을 선점하고, 마지막 트랜잭션에서 잠금을 해제한다. 
- 잠금 해제 전까지 다른 사용자는 잠금 사용 불가
- 오프라인 선점 방식은 잠금 유효 시간이 필요한데, 유효 시간이 지나면 자동으로 잠금을 해제해서 다른 사용자가 잠금을 일정 시간 후에 다시 구할 수 있도록 해야함

