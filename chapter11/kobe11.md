# 11.CQRS

## 단일 모델의 단점.

주문 내역 조희 기능을 구현하기 위해서는 여러 애그리거트에서 데이터를 가져와야한다.

여러 애그리거트에서 데이터를 가져오는 만큼 성능 문제가 발생할 수 있는데 이러한 문제를 해결하기 위해 구현 방식을 고민해야한다.
여러 애그리거트 → 식별자를 통한 즉시로딩 불가능 , 직접 참조 → 네이티브 쿼리 사용 문제

도메인 모델을 구현할 때 사용하는 ORM은 화면에 데이터를 출력하는 기능을 구현하기 보다는 도메인 상태 변경에 초점 → 여러 애그리거트를 가져오기에는 구현 복잡.  해결 방법에는 : 상태 변경을 위한 모델과 조회를 위한 모델을 분리.

## CQRS

시스템이 제공하는 기능은 크게 두가지로 나눌 수 있다.

- 상태를 변경하는 기능 - 주문 생성, 배송지 정보 변경, 암호를 변경
- 상태 정보를 조회하는 기능 - 주문 상세 내역 보기, 게시글 보기, 판매 통계 보기
(도메인 관점에서의 상태 변경은 주로 한 애그리거트의 상태를 변경)

상태를 변경하는 범위와 상태를 조회하는 범위가 정확하게 같지 않기에 단일 모델로 두 종류의 기능을 구현하면 모델이 복잡해진다. → 이러한 복잡도를 해결하기 위한 방법이 CQRS.
[상태를 변경하는 명령을 위한 모델과 상태를 제공하는 Query를 위한 모델을 분리하는 패턴.]

복잡한 도메인에 성능을 높이기 위해 JPA의 다양한 기능을 적용하는 것이 아닌, CQRS를 적용하여 별도의 조회 모델을 사용하여 간단하게 결과 확인. CQRS를 사용하여 각 모델에 맞는 구현 기술을 선택할 수 있다. 

예를 들어 명령 모델은 객체지향에 기반해서 도메인 모델을 구현하기에 적당한 JPA를 사용해서 구현하고, 조회 모델은 DB 테이블에서 SQL로 데이터를 조회할 때 좋은 마이바티스를 사용해서 구현하면 된다.

### 웹과 CQRS

웹은 조회하는 경우가 많기 때문에, 조회 전용 모델을 캐시해서 사용하는데, 이러한 기법은 결과적으로 CQRS를 적용하는 것과 같은 효과를 만든다.

조회 속도를 높이기 위해 명시적으로 명령 모델과 조회 모델을 구별해 복잡함을 막고, 조회 기능에 특화된 구현 기법을 적용하자.

### CQRS 장 단점

장점

- CQRS 패턴을 적용할 때 얻을 수 있는 장점은 명령 모델을 구현할 때 도메인 자체에 집중할 수 있다는 점이다.

명령 모델과 조회 모델을 구분하여 도메인 로직을 구현하는데 집중할 수 있다.

- 조회 성능을 향상 시키는데 유리하다.

웹의 예처럼 캐시나, 조회에 특화된 쿼리를 사용하여 조회 성능을 향상 시킬 수 있다.

단점

- 구현해야 하는 코드가 많다.
- 더 많은 구현 기술이 필요하다.

(나눠서 개발하기 때문에)

CQRS의 장단점을 고려해서 CQRS 패턴을 도입할지 여부를 결정해야 한다. 도메인이 복잡하지 않은데 CQRS를 도입하면 비용만 높아질 수 있다. 잘 판단해서 CQRS를 적용하도록 하자.